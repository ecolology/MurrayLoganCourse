---
title: "Bayesian GLMM Part 4"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(tidyverse) #for data wrangling
theme_set(theme_classic())
```

# Scenario

Someone did something for some reason.....

# Read in the data

```{r readData, results='markdown', eval=TRUE}
mckeon <- read_csv('../data/mckeon.csv', trim_ws=TRUE) %>%
  janitor::clean_names() %>% 
  mutate(block = factor(block),
         symbiont = factor(symbiont, levels=c('none','crabs','shrimp','both')))
glimpse(mckeon)
```


# Exploratory data analysis

Model formula:
$$
y_i \sim{} \mathcal{N}(n, p_i)\\
ln\left(\frac{p_i}{1-p_1}\right) =\boldsymbol{\beta} \bf{X_i} + \boldsymbol{\gamma} \bf{Z_i}
$$

where $\boldsymbol{\beta}$ and $\boldsymbol{\gamma}$ are vectors of the fixed and random effects parameters respectively 
and $\bf{X}$ is the model matrix representing the overall intercept and effects of symbionts on the probability of the colony experiencing predation.
$\bf{Z}$ represents a cell means model matrix for the random intercepts associated with individual coral colonies.

# Fit the model

```{r fitModel, results='markdown', eval=FALSE, hidden=TRUE}


ggplot(mckeon, aes(y=PREDATION, x=symbiont)) +
    geom_point(position=position_jitter(width=0.2, height=0))+
    facet_wrap(~block)

mckeon_rstan = stan_glmer(PREDATION ~ symbiont + (1|block),
                          data=mckeon, family=binomial(link='logit'),
                          iter=5000, warmup=2000, chains=3, thin=5, refresh=0,
                          cores=3)
mckeon_rstan %>% get_variables()
plot(mckeon_rstan,  'mcmc_trace', regex_pars='^.Intercept|symbiont|[sS]igma')
plot(mckeon_rstan,  'mcmc_acf_bar', regex_pars='^.Intercept|symbiont|[sS]igma')
plot(mckeon_rstan,  'mcmc_rhat_hist', regex_pars='^.Intercept|symbiont|[sS]igma')
plot(mckeon_rstan,  'mcmc_neff_hist', regex_pars='^.Intercept|symbiont|[sS]igma')


preds <- posterior_predict(mckeon_rstan,  nsamples=250,  summary=FALSE)
mckeon_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = mckeon$PREDATION,
                            fittedPredictedResponse = apply(preds, 2, median))
plot(mckeon_resids)

mckeon_rstan1 = stan_glmer(PREDATION ~ symbiont + (symbiont|block),
                           data=mckeon, family=binomial(link='logit'),
                           iter=5000, warmup=2000, chains=3, thin=5, refresh=0,
                          cores=3)

mckeon_rstan1 %>% get_variables()
plot(mckeon_rstan1,  'mcmc_trace', regex_pars='^.Intercept|^symbiont|[sS]igma')  
plot(mckeon_rstan1,  'mcmc_acf_bar', regex_pars='^.Intercept|^symbiont|[sS]igma')
plot(mckeon_rstan1,  'mcmc_rhat_hist', regex_pars='^.Intercept|^symbiont|[sS]igma')
plot(mckeon_rstan1,  'mcmc_neff_hist', regex_pars='^.Intercept|^symbiont|[sS]igma')


preds <- posterior_predict(mckeon_rstan1,  nsamples=250,  summary=FALSE)
mckeon_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = mckeon$PREDATION,
                            fittedPredictedResponse = apply(preds, 2, median))
plot(mckeon_resids)

#prior_summary(mckeon_rstan1)
#posterior_vs_prior(mckeon_rstan1, color_by='vs', group_by=TRUE,
#                   facet_args=list(scales='free_y'))

loo(mckeon_rstan)
loo(mckeon_rstan1)

#as.matrix(mckeon_rstan1) %>% colnames
#posterior_vs_prior(mckeon_rstan1, color_by='vs', group_by=TRUE,
#                   regex_pars=c('^(Intercept)','^symbiont','^[sS]igma'), 
#                   facet_args=list(scales='free_y'))

## mckeon_rstan1 = stan_glmer(PREDATION ~ symbiont + (symbiont|block),
##                           data=mckeon, family=binomial(link='logit'),
##                           iter=4000, warmup=1000, chains=3, thin=5, refresh=0,
##                           cores=3,
##                           prior_intercept = normal(0,10),
##                           prior=normal(0,2.5),
##                           prior_covariance = decov(1,1,1,4))
## posterior_vs_prior(mckeon_rstan1, color_by='vs', group_by=TRUE, regex_pars=c('^(Intercept)','^symbiont','^[sS]igma'), 
##                    facet_args=list(scales='free_y'))
ggpredict(mckeon_rstan1) %>% plot
summary(mckeon_rstan1)

mckeon_rstan1 %>% get_variables()
nms=colnames(as.matrix(mckeon_rstan1))
wch = grep('^.Intercept|^symbiont',nms)
#posterior_vs_prior(mckeon_rstan1, color_by='vs', group_by=TRUE,
#                   facet_args=list(scales='free_y'), pars=nms[wch])



tidyMCMC(mckeon_rstan1$stanfit,conf.int=TRUE, conf.method='HPDinterval',
         rhat=TRUE, ess=TRUE,  pars=nms[wch])

emmeans(mckeon_rstan1, pairwise~symbiont, type='response')
mckeon_em = emmeans(mckeon_rstan1, pairwise~symbiont, type='link')$contrasts %>%
      gather_emmeans_draws() %>%
      mutate(PEff=exp(.value))
mckeon_em %>% head
mckeon_em %>%
  group_by(contrast) %>%
  dplyr::select(contrast, PEff) %>%
  median_hdci
mckeon_em %>%
  group_by(contrast) %>%
  summarize(Prob=sum(PEff>1)/n())

cmat=cbind(
    crab_vs_shrimp=c(0,1,-1,0),
    one_vs_both=c(0,-1/2,-1/2,1),
    symbiont=c(1, -1/3, -1/3,-1/3)
)
mckeon_em = emmeans(mckeon_rstan1, ~symbiont, contr=list(cmat), type='link')$contrast %>%
                                                                 gather_emmeans_draws() %>%
                                                                 mutate(Fit=exp(.value)) 
mckeon_em %>%
  group_by(contrast) %>%
  median_hdci(Fit)

mckeon_em %>%
  group_by(contrast) %>%
  summarize(sum(Fit>1)/n())                                                                      

newdata = emmeans(mckeon_rstan1, ~symbiont, type='response') %>% as.data.frame
head(newdata)
ggplot(newdata, aes(y=prob, x=symbiont)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD))

```

```{r fitModel.brms, results='markdown', eval=FALSE, hidden=TRUE}
mckeon = mckeon %>% mutate(block=factor(block),
   symbiont=factor(symbiont, levels=c('none','crabs','shrimp','both')))

ggplot(mckeon, aes(y=PREDATION, x=symbiont)) +
    geom_point(position=position_jitter(width=0.2, height=0))+
    facet_wrap(~block)

ggplot(mckeon, aes(y=PREDATION, x=symbiont)) +
    geom_point()+
    facet_wrap(~block)
mckeon_form <- bf(PREDATION | trials(1) ~ symbiont + (1|block),
                  family=binomial(link='logit'))
mckeon_brms <- brm(mckeon_form,
                   data=mckeon,
                   iter=5000, warmup=2000, chains=3, thin=5, refresh=0,
                   cores=3)
mcmc_plot(mckeon_brms,  type='trace')

mckeon_brms %>% get_variables()
mcmc_plot(mckeon_brms,  type='trace')
, regex_pars='^.Intercept|symbiont|sd')
mcmc_plot(mckeon_brms,  type='acf_bar')
, regex_pars='^.Intercept|symbiont|sd')
mcmc_plot(mckeon_brms,  type='rhat_hist')
, regex_pars='^.Intercept|symbiont|sd')
mcmc_plot(mckeon_brms,  type='neff_hist')
, regex_pars='^.Intercept|symbiont|sd')


preds <- posterior_predict(mckeon_brms,  nsamples=250,  summary=FALSE)
mckeon_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = mckeon$PREDATION,
                            fittedPredictedResponse = apply(preds, 2, median),
                            integerResponse=TRUE)
plot(mckeon_resids)

mckeon_form <- bf(PREDATION | trials(1) ~ symbiont + (symbiont|block),  family=binomial(link='logit'))
mckeon_brms1 <- brm(mckeon_form,
                   data=mckeon,
                   iter=5000, warmup=2000, chains=3, thin=5, refresh=0,
                   cores=3)

mcmc_plot(mckeon_brms1,  type='trace')
mcmc_plot(mckeon_brms1,  type='trace', regex_pars='^.Intercept|symbiont|sd')
mcmc_plot(mckeon_brms1,  type='acf_bar')
, regex_pars='^.Intercept|symbiont|sd')
mcmc_plot(mckeon_brms1,  type='rhat_hist')
, regex_pars='^.Intercept|symbiont|sd')
mcmc_plot(mckeon_brms1,  type='neff_hist')
, regex_pars='^.Intercept|symbiont|sd')

preds <- posterior_predict(mckeon_brms1,  nsamples=250,  summary=FALSE)
mckeon_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = mckeon$PREDATION,
                            fittedPredictedResponse = apply(preds, 2, median),
                            integerResponse = TRUE)
plot(mckeon_resids)

#prior_summary(mckeon_brms1)
#posterior_vs_prior(mckeon_brms1, color_by='vs', group_by=TRUE,
#                   facet_args=list(scales='free_y'))

loo(mckeon_brms)
loo(mckeon_brms1)

#as.matrix(mckeon_brms1) %>% colnames
#posterior_vs_prior(mckeon_brms1, color_by='vs', group_by=TRUE,
#                   regex_pars=c('^(Intercept)','^symbiont','^[sS]igma'), 
#                   facet_args=list(scales='free_y'))

## mckeon_brms1 = stan_glmer(PREDATION ~ symbiont + (symbiont|block),
##                           data=mckeon, family=binomial(link='logit'),
##                           iter=4000, warmup=1000, chains=3, thin=5, refresh=0,
##                           cores=3,
##                           prior_intercept = normal(0,10),
##                           prior=normal(0,2.5),
##                           prior_covariance = decov(1,1,1,4))
## posterior_vs_prior(mckeon_brms1, color_by='vs', group_by=TRUE, regex_pars=c('^(Intercept)','^symbiont','^[sS]igma'), 
##                    facet_args=list(scales='free_y'))
ggpredict(mckeon_brms1) %>% plot

mckeon_brms1 %>% get_variables()
nms=colnames(as.matrix(mckeon_brms1))
wch = grep('^b.Intercept|^b.symbiont|^sd',nms)
#posterior_vs_prior(mckeon_brms1, color_by='vs', group_by=TRUE,
#                   facet_args=list(scales='free_y'), pars=nms[wch])



summary(mckeon_brms1)
tidyMCMC(mckeon_brms1$fit,  estimate.method = 'median',
         conf.int=TRUE,  conf.method = 'HPDinterval',
         rhat=TRUE, ess=TRUE)
tidyMCMC(mckeon_brms1$fit,conf.int=TRUE, conf.method='HPDinterval',
         rhat=TRUE, ess=TRUE,  pars=nms[wch])
tidyMCMC(mckeon_brms1$fit,conf.int=TRUE, conf.method='HPDinterval',
         rhat=TRUE, ess=TRUE)

emmeans(mckeon_brms1, pairwise~symbiont, type='response')
mckeon_em = emmeans(mckeon_brms1, pairwise~symbiont, type='link')$contrasts %>%
      gather_emmeans_draws() %>%
      mutate(PEff=exp(.value))#,
             #Prob = plogis(.value))
mckeon_em %>% head
mckeon_em %>%
  group_by(contrast) %>%
  dplyr::select(contrast, PEff) %>%
  median_hdi
mckeon_em %>%
  group_by(contrast) %>%
  summarize(Prob=sum(PEff>1)/n())

mckeon_em = emmeans(mckeon_brms1, ~symbiont, type='link') %>%
      gather_emmeans_draws()
mckeon_em %>% mutate(P=plogis(.value)) %>% median_hdci(P)

mutate(PEff=exp(.value)))#,
             #Prob = plogis(.value))

cmat=cbind(
    crab_vs_shrimp=c(0,1,-1,0),
    one_vs_both=c(0,-1/2,-1/2,1),
    symbiont=c(1, -1/3, -1/3,-1/3)
)
mckeon_em = emmeans(mckeon_brms1, ~symbiont, contr=list(cmat), type='link')$contrast %>%
                                                                 gather_emmeans_draws() %>%
                                                                 mutate(Fit=exp(.value)) 
mckeon_em %>%
  group_by(contrast) %>%
  median_hdi(Fit)

mckeon_em %>%
  group_by(contrast) %>%
  summarize(sum(Fit>1)/n())                                                                      

newdata = emmeans(mckeon_brms1, ~symbiont, type='response') %>% as.data.frame
head(newdata)
ggplot(newdata, aes(y=prob, x=symbiont)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD))

```
# Model validation

# Model investigation / hypothesis testing

# Predictions

# Summary figures

# References
