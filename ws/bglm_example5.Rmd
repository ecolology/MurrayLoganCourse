---
title: "Bayesian GLM Part5"
author: "Murray Logan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
    css: ../resources/style.css
  pdf_document:
    df_print: default
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    latex_engine: xelatex
    number_sections: yes
    toc_depth: 2
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 4
    highlight: tango
    toc: yes
    toc_depth: 2
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: ../resources/references.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Preparations

Load the necessary libraries

```{r libraries, results='markdown', eval=TRUE}
library(rstanarm)   #for fitting models in STAN
library(brms)       #for fitting models in STAN
library(coda)       #for diagnostics
library(ggmcmc)     #for MCMC diagnostics
library(bayesplot)  #for diagnostics
library(rstan)      #for interfacing with STAN
library(DHARMa)     #for residual diagnostics
library(emmeans)    #for marginal means etc
library(broom)      #for tidying outputs
library(broom.mixed)
library(tidybayes)  #for more tidying outputs
library(ggeffects)  #for partial plots
library(tidyverse)  #for data wrangling etc
library(patchwork)
theme_set(theme_classic())
```


# Scenario

Here is a modified example from @Quinn-2002-2002. Day and Quinn
(1989) described an experiment that examined how rock surface type
affected the recruitment of barnacles to a rocky shore. The experiment
had a single factor, surface type, with 4 treatments or levels: algal
species 1 (ALG1), algal species 2 (ALG2), naturally bare surfaces (NB)
and artificially scraped bare surfaces (S). There were 5 replicate plots
for each surface type and the response (dependent) variable was the
number of newly recruited barnacles on each plot after 4 weeks.

![Six-plated barnacle](../resources/barnacles.jpg){width="224" height="308"}

Format of day.csv data files

treat   barnacle
------- ----------
ALG1    27
..      ..
ALG2    24
..      ..
NB      9
..      ..
S       12
..      ..

-------------- ----------------------------------------------------------------------------------------------------------------------------------------------
**treat**      Categorical listing of surface types. ALG1 = algal species 1, ALG2 = algal species 2, NB = naturally bare surface, S = scraped bare surface.
**barnacle**   The number of newly recruited barnacles on each plot after 4 weeks.
-------------- ----------------------------------------------------------------------------------------------------------------------------------------------



# Read in the data

```{r readData, results='markdown', eval=TRUE}
day <- read_csv('../data/day.csv', trim_ws=TRUE) %>%
  janitor::clean_names()
glimpse(day)
```

Start by declaring the categorical variables as factor.

```{r prepare, results='markdown', eval=TRUE, hidden=TRUE}
day = day %>% mutate(treat=factor(treat))
```

Model formula:
$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0,10)\\
\beta_{1,2,3} &\sim{} \mathcal{N}(0,1)\\
\end{align}
$$

where $\boldsymbol{\beta}$ is a vector of effects parameters and $\bf{X}$ is a model matrix representing the intercept and treatment contrasts for the effects of Treatment on barnacle recruitment.

# Exploratory data analysis {.tabset .tabset-faded}


# Fit the model {.tabset .tabset-faded}


# MCMC sampling diagnostics {.tabset .tabset-faded}



# Model validation {.tabset .tabset-faded}




# Partial effects plots {.tabset .tabset-faded}



# Model investigation {.tabset .tabset-faded}


 
# Further investigations 


## Post-hoc test (Tukey's){.tabset .tabset-faded}



## Planned contrasts{.tabset .tabset-faded}

Define your own

Compare:

a) ALG1 vs ALG2
b) NB vs S
c) average of ALG1+ALG2 vs NB+S


# Summary Figure {.tabset .tabset-faded}




```{r fitModel, results='markdown', echo=FALSE,eval=FALSE, hidden=TRUE}
day_rstanarm <- stan_glm(barnacle ~ treat, data=day,
                      family=poisson(link='log'),
                      chains = 3,iter = 5000, warmup=2000, thin=5,
                      refresh=0)
prior_summary(day_rstanarm)

day_rstanarm <- stan_glm(barnacle ~ treat, data=day, family='poisson',
                      prior = normal(c(0,0,0), c(2.5,2.5,2.5)),
                      prior_intercept = normal(0,10),
                      chains = 3,iter = 2000, thin=2, refresh=0)
prior_summary(day_rstanarm)

plot(day_rstanarm,  'mcmc_trace')
plot(day_rstanarm,  'mcmc_acf_bar')
plot(day_rstanarm,  'mcmc_rhat_hist')
plot(day_rstanarm,  'mcmc_neff_hist')


preds <- posterior_predict(day_rstanarm,  nsamples=250,  summary=FALSE)
day_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = day$barnacle,
                           fittedPredictedResponse = apply(preds, 2, median),
                           integerResponse = TRUE)
plot(day_resids)


#pp_check(day_rstanarm, x=as.numeric(day$treat),'intervals')




## Compare the proportion of zeros in the observed and expected data
#yrep = posterior_predict(day_rstan)
prop_zero <- function(y) mean(y == 0)
(prop_zero_test1 <- pp_check(day_rstanarm, plotfun = "stat", stat = "prop_zero"))
                                        # no zeros - so not zero inflated


day_rstanarmNB <- stan_glm(barnacle ~ treat, data=day,
                      family='neg_binomial_2',
                      chains = 3,iter = 5000, thin=5, warmup=2000, refresh=0)
preds <- posterior_predict(day_rstanarmNB,  nsamples=250,  summary=FALSE)
day_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = day$barnacle,
                            fittedPredictedResponse = apply(preds, 2, median))
plot(day_resids)


day_rstanNB <- update(day_rstan, family = neg_binomial_2)
(loo.P=loo(day_rstan))
(loo.NB=loo(day_rstanNB))
compare_models(loo.P, loo.NB)

ggpredict(day_rstanarm, term='treat') %>% plot
ggpredict(day_rstanarm, ~treat) %>% plot
ggemmeans(day_rstanarm, ~treat) %>% plot


summary(day_rstanarm)
library(tidybayes)
tidyMCMC(day_rstanarm$stanfit, conf.int=TRUE,
         conf.method='HPDinterval', rhat=TRUE,ess=TRUE)


# Pairwise comparisons
library(emmeans)
## factor statements
emmeans(day_rstanarm, pairwise~treat, type='response')
## what about probabilities
day_em = emmeans(day_rstanarm, pairwise~treat, type='link')$contrasts %>%
    gather_emmeans_draws() %>%
    mutate(Fit=exp(.value))
day_em %>% head
day_em %>% group_by(contrast) %>%
    ggplot(aes(x=Fit)) +
    geom_histogram() +
    geom_vline(xintercept=1, color='red') + 
    facet_wrap(~contrast, scales='free')
day_em %>% group_by(contrast) %>% median_hdi()
# Probability of effect
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1.1)/n())


##Planned contrasts
cmat<-cbind('Alg2_Alg1'=c(-1,1,0,0),
              'NB_S'=c(0,0,1,-1),
             'Alg_Bare'=c(0.5,0.5,-0.5,-0.5),
             'Alg_NB'=c(0.5,0.5,-1,0))
#crossprod(cmat)
emmeans(day_rstanarm, ~treat, contr=list(treat=cmat), type='link')
emmeans(day_rstanarm, ~treat, contr=list(treat=cmat), type='response')
day_em = emmeans(day_rstanarm, ~treat, contr=list(treat=cmat), type='link')$contrasts %>%
      gather_emmeans_draws() %>% mutate(Fit=exp(.value)) 
day_em %>% group_by(contrast) %>% mean_hdi()
# Probability of effect
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1.5)/n())

hist(bayes_R2(day_rstanarmNB))

bayes_R2(day_rstanarm) %>% median_hdi
bayes_R2(day_rstanarmNB) %>% hist


## Summary plot
day_grid = with(day, list(treat=levels(treat)))
newdata = emmeans(day_rstanarm, ~treat, type='response') %>% as.data.frame
head(newdata)
ggplot(newdata, aes(y=rate, x=treat)) +
    geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD))
```

                                           
```{r fitModel.brms, results='markdown', eval=FALSE, hidden=TRUE}
day_form <- bf(barnacle ~ treat,  family=poisson(link='log'))
get_prior(day_form,  data=day)
day_priors <- c(
  prior(normal(0, 10),  class='Intercept'),
  prior(normal(0, 2.5), class='b')
)
day_brms <- brm(day_form, data=day,
                prior=day_priors, 
                 chains=3,  iter=5000,  warmup=2000, thin=5,
                 refresh=0)

plot(day_brms)
mcmc_plot(day_brms,  type='acf_bar')
mcmc_plot(day_brms,  type='rhat_hist')
mcmc_plot(day_brms,  type='neff_hist')

preds <- posterior_predict(day_brms, nsamples=250, summary=FALSE)
day_resids <- createDHARMa(simulatedResponse = t(preds),
                            observedResponse = day$barnacle,
                           fittedPredictedResponse = apply(preds, 2, median),
                           integerResponse = TRUE)
plot(day_resids)

                                        #pp_check(day_brmsP, x=as.numeric(day$treat),'intervals')


ggpredict(day_brms, term='treat') %>% plot
ggpredict(day_brms, ~treat) %>% plot
ggemmeans(day_brms, ~treat) %>% plot

summary(day_brms)

tidyMCMC(day_brms$fit, conf.int=TRUE,
         conf.method='HPDinterval', rhat=TRUE,ess=TRUE)

# Pairwise comparisons
library(emmeans)
## factor statements
emmeans(day_brms, pairwise~treat, type='response')
## what about probabilities
day_em = emmeans(day_brms, pairwise~treat, type='link')$contrasts %>%
    gather_emmeans_draws() %>%
    mutate(Fit=exp(.value))
day_em %>% head
day_em %>% group_by(contrast) %>%
    ggplot(aes(x=Fit)) +
    geom_histogram() +
    geom_vline(xintercept=1, color='red') + 
    facet_wrap(~contrast, scales='free')
day_em %>% group_by(contrast) %>% median_hdi(.width=c(0.8, 0.95))

day_sum <- day_em %>%
  group_by(contrast) %>%
  median_hdci(.width=c(0.8, 0.95))
day_sum
ggplot(day_sum) +
  geom_hline(yintercept=1, linetype='dashed') +
  geom_pointrange(aes(x=contrast, y=Fit, ymin=Fit.lower, ymax=Fit.upper, size=factor(.width)),
                  show.legend = FALSE) +
  scale_size_manual(values=c(1, 0.5)) +
  coord_flip()

g1 <- ggplot(day_sum) +
  geom_hline(yintercept=1) +
  geom_pointrange(aes(x=contrast, y=Fit, ymin=Fit.lower, ymax=Fit.upper, size=factor(.width)), show.legend = FALSE) +
  scale_size_manual(values=c(1, 0.5)) +
  scale_y_continuous(trans=scales::log2_trans(),  breaks=c(0.5, 1, 2, 4)) +
  coord_flip()
g1
                                        # Probability of effect
day_em %>% group_by(contrast) %>% summarize(P=sum(.value>0)/n())
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1.1)/n())

##Planned contrasts
cmat<-cbind('Alg2_Alg1'=c(-1,1,0,0),
              'NB_S'=c(0,0,1,-1),
             'Alg_Bare'=c(0.5,0.5,-0.5,-0.5),
             'Alg_NB'=c(0.5,0.5,-1,0))
#crossprod(cmat)
emmeans(day_brms, ~treat, contr=list(treat=cmat), type='link')
emmeans(day_brms, ~treat, contr=list(treat=cmat), type='response')
day_em = emmeans(day_brms, ~treat, contr=list(treat=cmat), type='link')$contrasts %>%
      gather_emmeans_draws() %>%
      mutate(Fit=exp(.value)) 
day_em %>% group_by(contrast) %>% median_hdci()
# Probability of effect
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1)/n())
##Probability of effect greater than 10%
day_em %>% group_by(contrast) %>% summarize(P=sum(Fit>1.1)/n())

hist(bayes_R2(day_brms, summary=FALSE))

bayes_R2(day_brms, summary=FALSE) %>% median_hdi


## Summary plot
day_grid = with(day, list(treat=levels(treat)))
newdata = emmeans(day_brms, ~treat, type='response') %>% as.data.frame
head(newdata)
g2 <- ggplot(newdata, aes(y=rate, x=treat)) +
  geom_pointrange(aes(ymin=lower.HPD, ymax=upper.HPD))

library(patchwork)
g1 + g2
```

# References
